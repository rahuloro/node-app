name: Node.js CI

on:
  push:
    branches: [dev, prod]

jobs:
  setup-runner:
    runs-on: [self-hosted, dev]
    outputs:
      myrunner: ${{ steps.set-myrunner.outputs.myrunner }}
    steps:
      - id: set-myrunner
        run: echo "::set-output name=myrunner::${GITHUB_REF#refs/heads/}"

  build:
    needs: setup-runner
    runs-on: ${{needs.setup-runner.outputs.myrunner}}
    environment: ${{needs.setup-runner.outputs.myrunner}}
    strategy:
      matrix:
        node-version: [14]

    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-node@v3
      with:
        node-version: 14


    - name: Setup env files
      env:
        ENV_FILE: ${{ secrets.HELLO }}
      run: |
        echo "${ENV_FILE}" > /home/ubuntu/.env

    - name: Code Setup
      run: |
        npm ci
        sudo cp -r ${GITHUB_WORKSPACE} /home/ubuntu/
        sudo mv ~/.env ~/node-app/.env
        cd ~
        pwd
        chmod +x ~/pm2_runner.sh
        bash ./pm2_runner.sh